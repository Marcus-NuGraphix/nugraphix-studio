name: CI

on:
    push:
        branches: [dev, main]
    pull_request:
        branches: [dev, main]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    bootstrap-smoke:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: username
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: mydb
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U username -d mydb"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 10
        env:
            NODE_ENV: development
            DATABASE_URL: postgresql://username:password@localhost:5432/mydb
            BETTER_AUTH_SECRET: ci-local-bootstrap-secret-not-for-production
            BETTER_AUTH_URL: http://localhost:3000
            BETTER_AUTH_BASE_URL: http://localhost:3000
            PUBLIC_APP_URL: http://localhost:3000
            S3_REGION: us-east-1
            S3_BUCKET: ci-bootstrap-assets
            S3_ACCESS_KEY_ID: ci-access-key
            S3_SECRET_ACCESS_KEY: ci-secret-key
            EMAIL_PROVIDER: noop
            EMAIL_FROM_ADDRESS: ci@example.com
            CONTACT_NOTIFICATION_EMAIL: ci@example.com
            SEED_ADMIN_EMAIL: admin@demo.co.za
            SEED_ADMIN_NAME: Demo Admin
            SEED_ADMIN_PASSWORD: DevDemo!123
            SEED_USER_EMAIL: user@demo.co.za
            SEED_USER_NAME: Demo User
            SEED_USER_PASSWORD: DevDemo!123

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Migration and bootstrap seed smoke
              run: |
                  pnpm db:migrate
                  pnpm db:seed
                  pnpm db:seed

    build:
        needs: bootstrap-smoke
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Lint
              run: pnpm lint

            - name: Typecheck
              run: pnpm exec tsc -p tsconfig.json --noEmit

            - name: Test
              run: pnpm test

            - name: Build
              run: pnpm build
